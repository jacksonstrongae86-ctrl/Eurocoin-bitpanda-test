@model BitpandaExplorer.Models.History.PriceHistoryViewModel
@{
    ViewData["Title"] = $"Historial {Model.Symbol}";
    var allowedDays = ViewBag.AllowedDays as int[];
    var currencies = ViewBag.Currencies as string[];
    var isPositive = Model.ChangePercent >= 0;
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1>
            <i class="bi bi-graph-up-arrow"></i> 
            @Model.Symbol 
            <small class="text-muted">@Model.Name</small>
        </h1>
        <p class="text-muted mb-0">
            Historial de @Model.Days días • Datos de CoinGecko
        </p>
    </div>
    <a href="/History" class="btn btn-outline-light">
        <i class="bi bi-arrow-left"></i> Cambiar activo
    </a>
</div>

@if (!Model.IsSuccess)
{
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle"></i> @Model.ErrorMessage
    </div>
    <a href="/History" class="btn btn-primary">Seleccionar otro activo</a>
}
else
{
    <!-- Estadísticas -->
    <div class="row mb-4">
        <div class="col-md-3 col-6 mb-3">
            <div class="stat-card">
                <div class="stat-value">
                    @(Model.Currency == "EUR" ? "€" : "$")@Model.CurrentPrice.ToString("N2")
                </div>
                <div class="stat-label">Precio Actual</div>
            </div>
        </div>
        <div class="col-md-3 col-6 mb-3">
            <div class="stat-card">
                <div class="stat-value @(isPositive ? "text-success" : "text-danger")">
                    @(isPositive ? "+" : "")@Model.ChangePercent.ToString("N2")%
                </div>
                <div class="stat-label">Cambio (@Model.Days días)</div>
            </div>
        </div>
        <div class="col-md-3 col-6 mb-3">
            <div class="stat-card">
                <div class="stat-value text-success">
                    @(Model.Currency == "EUR" ? "€" : "$")@Model.HighPrice.ToString("N2")
                </div>
                <div class="stat-label">Máximo</div>
            </div>
        </div>
        <div class="col-md-3 col-6 mb-3">
            <div class="stat-card">
                <div class="stat-value text-danger">
                    @(Model.Currency == "EUR" ? "€" : "$")@Model.LowPrice.ToString("N2")
                </div>
                <div class="stat-label">Mínimo</div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card bg-dark mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Período</label>
                    <div class="btn-group w-100" role="group">
                        @if (allowedDays != null)
                        {
                            @foreach (var d in allowedDays)
                            {
                                var label = d == 1 ? "24h" : d == 365 ? "1 año" : $"{d}d";
                                var isActive = d == Model.Days;
                                <a href="/History/@Model.Symbol?days=@d&currency=@Model.Currency.ToLower()" 
                                   class="btn @(isActive ? "btn-primary" : "btn-outline-light")">
                                    @label
                                </a>
                            }
                        }
                    </div>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Moneda</label>
                    <div class="btn-group w-100" role="group">
                        @if (currencies != null)
                        {
                            @foreach (var c in currencies)
                            {
                                var isActive = c.ToUpper() == Model.Currency;
                                <a href="/History/@Model.Symbol?days=@Model.Days&currency=@c" 
                                   class="btn @(isActive ? "btn-primary" : "btn-outline-light")">
                                    @c.ToUpper()
                                </a>
                            }
                        }
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Gráfico -->
    <div class="card bg-dark mb-4">
        <div class="card-header bg-secondary d-flex justify-content-between align-items-center">
            <span><i class="bi bi-bar-chart-line"></i> Gráfico de Precios</span>
            <small class="text-muted">@Model.Prices.Count puntos de datos</small>
        </div>
        <div class="card-body">
            <canvas id="priceChart" height="300"></canvas>
        </div>
    </div>

    <!-- Tabla de datos -->
    <div class="card bg-dark">
        <div class="card-header bg-secondary">
            <i class="bi bi-table"></i> Datos Recientes
        </div>
        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                <table class="table table-dark table-hover mb-0">
                    <thead style="position: sticky; top: 0; background: #2d2d44;">
                        <tr>
                            <th>Fecha</th>
                            <th class="text-end">Precio (@Model.Currency)</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var point in Model.Prices.TakeLast(50).Reverse())
                        {
                            <tr>
                                <td>@point.Date.ToString("dd/MM/yyyy HH:mm")</td>
                                <td class="text-end">
                                    @(Model.Currency == "EUR" ? "€" : "$")@point.Price.ToString("N2")
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        var ctx = document.getElementById('priceChart').getContext('2d');
        var labels = @Html.Raw(Model.ChartLabelsJson);
        var data = @Html.Raw(Model.ChartDataJson);
        var isPositive = @(isPositive ? "true" : "false");
        
        var gradient = ctx.createLinearGradient(0, 0, 0, 300);
        if (isPositive) {
            gradient.addColorStop(0, 'rgba(0, 184, 148, 0.3)');
            gradient.addColorStop(1, 'rgba(0, 184, 148, 0.0)');
        } else {
            gradient.addColorStop(0, 'rgba(233, 69, 96, 0.3)');
            gradient.addColorStop(1, 'rgba(233, 69, 96, 0.0)');
        }

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '@Model.Symbol Price (@Model.Currency)',
                    data: data,
                    borderColor: isPositive ? '#00b894' : '#e94560',
                    backgroundColor: gradient,
                    fill: true,
                    tension: 0.3,
                    pointRadius: 0,
                    pointHitRadius: 10,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: '#1a1a2e',
                        titleColor: '#eaeaea',
                        bodyColor: '#eaeaea',
                        borderColor: '#e94560',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                return '@(Model.Currency == "EUR" ? "€" : "$")' + context.parsed.y.toFixed(2);
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        grid: {
                            color: 'rgba(255,255,255,0.1)'
                        },
                        ticks: {
                            color: '#888',
                            maxTicksLimit: 8
                        }
                    },
                    y: {
                        display: true,
                        grid: {
                            color: 'rgba(255,255,255,0.1)'
                        },
                        ticks: {
                            color: '#888',
                            callback: function(value) {
                                return '@(Model.Currency == "EUR" ? "€" : "$")' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    </script>
}
